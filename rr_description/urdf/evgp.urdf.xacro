<robot name="evgp" xmlns:xacro="http://www.ros.org/wiki/xacro">

    <xacro:property name="props" value="${load_yaml('../conf/evgp_car_params.yaml')}"/>

    <!-- ************************** Links *************************** -->

    <xacro:macro name="null_inertia">
        <inertial>
            <mass value="0.001"/>
            <inertia ixx="0.001" ixy="0" ixz="0" iyy="0.001" iyz="0" izz="0.001"/>
        </inertial>
    </xacro:macro>

    <xacro:macro name="mesh_geometry">
        <geometry>
            <mesh filename="package://rr_description/meshes/EVGP_robot.STL" scale="0.001 0.001 0.001"/>
        </geometry>
    </xacro:macro>

    <link name="base_footprint">
        <xacro:null_inertia/>
    </link>

    <link name="body_visual_origin">
        <xacro:null_inertia/>
        <visual>
            <xacro:mesh_geometry/>
        </visual>
        <collision>
            <xacro:mesh_geometry/>
        </collision>
    </link>

    <xacro:property name="body_inertia" value="${props['body_inertia']}"/>
    <link name="body_inertial_center">
        <inertial>
            <mass value="${props['body_mass']}"/>
            <inertia ixx="${body_inertia[0]}" ixy="${body_inertia[1]}" ixz="${body_inertia[2]}"
                     iyy="${body_inertia[3]}" iyz="${body_inertia[4]}" izz="${body_inertia[5]}"/>
        </inertial>
    </link>
    <gazebo reference="body_inertial_center"/>


    <xacro:macro name="wheel_link" params="name radius width">
        <link name="${name}">
            <inertial>
                <mass value="0.01"/>
                <inertia ixx="0.001" ixy="0" ixz="0" iyy="0.001" iyz="0"
                         izz="${0.5 * props['wheel_mass'] * pow(radius, 2)}"/>
            </inertial>
            <visual>
                <geometry>
                    <cylinder radius="${radius}" length="${width}"/>
                </geometry>
            </visual>
            <collision>
                <geometry>
                    <cylinder radius="${radius}" length="${width}"/>
                </geometry>
            </collision>
        </link>
        <gazebo reference="${name}">
            <mu1>0.7</mu1>
            <mu2>0.7</mu2>
            <kp>1000000</kp>
            <kd>1000000</kd>
        </gazebo>
    </xacro:macro>
    <xacro:wheel_link name="wheel_BL" radius="${props['wheel_radius_back']}" width="${props['wheel_width_back']}"/>
    <xacro:wheel_link name="wheel_BR" radius="${props['wheel_radius_back']}" width="${props['wheel_width_back']}"/>
    <xacro:wheel_link name="wheel_FL" radius="${props['wheel_radius_front']}" width="${props['wheel_width_front']}"/>
    <xacro:wheel_link name="wheel_FR" radius="${props['wheel_radius_front']}" width="${props['wheel_width_front']}"/>

    <link name="steering_link_left">
        <xacro:null_inertia/>
    </link>
    <link name="steering_link_right">
        <xacro:null_inertia/>
    </link>


    <!-- ************************** Joints *************************** -->

    <joint name="base_footprint_to_mesh_origin" type="fixed">
        <parent link="base_footprint"/>
        <child link="body_visual_origin"/>
        <origin xyz="1.45 0.508 -0.051"  rpy="${pi/2} 0 ${-pi/2}"/>
    </joint>

    <joint name="base_footprint_to_body_inertial_center" type="fixed">
        <parent link="base_footprint"/>
        <child link="body_inertial_center"/>
        <origin xyz="${' '.join(str(x) for x in props['body_com'])}"/>
    </joint>

    <xacro:macro name="back_wheel_joint" params="dest_link y">
        <joint name="base_footprint_to_${dest_link}" type="continuous">
            <parent link="base_footprint"/>
            <child link="${dest_link}"/>
            <origin xyz="0 ${y} ${props['wheel_radius_back'] / 2}" rpy="${-pi/2} 0 0"/>
            <axis xyz="0 0 1"/>
            <dynamics damping="0.01"/>
        </joint>
        <gazebo reference="base_footprint_to_${dest_link}"/>
    </xacro:macro>
    <xacro:back_wheel_joint dest_link="wheel_BL" y="${props['track'] / 2}"/>
    <xacro:back_wheel_joint dest_link="wheel_BR" y="${-props['track'] / 2}"/>

    <xacro:macro name="steering_joints" params="steering_link wheel_link y">
        <joint name="base_footprint_to_${steering_link}" type="revolute">
            <parent link="base_footprint"/>
            <child link="${steering_link}"/>
            <origin xyz="${props['wheelbase']} ${y} ${props['wheel_radius_front'] / 2}" rpy="0 0 0"/>
            <axis xyz="0 0 1"/>
            <limit lower="${-props['max_steering']}" upper="${props['max_steering']}" effort="10000.0"
                   velocity="${props['steering_speed']}"/>
        </joint>
        <gazebo reference="base_footprint_to_${steering_link}"/>

        <joint name="${steering_link}_to_${wheel_link}" type="continuous">
            <origin xyz="0 0 0" rpy="${pi/2} 0 0"/>
            <parent link="${steering_link}"/>
            <child link="${wheel_link}"/>
            <axis xyz="0 0 1"/>
        </joint>
        <gazebo reference="${steering_link}_to_${wheel_link}"/>
    </xacro:macro>
    <xacro:steering_joints steering_link="steering_link_left" wheel_link="wheel_FL" y="${props['track'] / 2}"/>
    <xacro:steering_joints steering_link="steering_link_right" wheel_link="wheel_FR" y="${-props['track'] / 2}"/>


    <!-- ****************** Actuators ********************** -->

    <gazebo>
        <plugin name="gazebo_ros_control" filename="libgazebo_ros_control.so">
            <robotNamespace>/</robotNamespace>
        </plugin>
    </gazebo>

    <transmission name="trans_back_left">
        <type>transmission_interface/SimpleTransmission</type>
        <joint name="base_footprint_to_wheel_BL">
            <hardwareInterface>hardware_interface/EffortJointInterface</hardwareInterface>
        </joint>
        <actuator name="motor_left">
            <hardwareInterface>hardware_interface/EffortJointInterface</hardwareInterface>
            <mechanicalReduction>1</mechanicalReduction>
        </actuator>
    </transmission>

    <transmission name="trans_back_right">
        <type>transmission_interface/SimpleTransmission</type>
        <joint name="base_footprint_to_wheel_BR">
            <hardwareInterface>hardware_interface/EffortJointInterface</hardwareInterface>
        </joint>
        <actuator name="motor_right">
            <hardwareInterface>hardware_interface/EffortJointInterface</hardwareInterface>
            <mechanicalReduction>1</mechanicalReduction>
        </actuator>
    </transmission>

    <transmission name="left_steering_trans">
        <type>transmission_interface/SimpleTransmission</type>
        <joint name="base_footprint_to_steering_link_left">
            <hardwareInterface>hardware_interface/EffortJointInterface</hardwareInterface>
        </joint>
        <actuator name="left_steer_motor">
            <hardwareInterface>hardware_interface/EffortJointInterface</hardwareInterface>
            <mechanicalReduction>1</mechanicalReduction>
        </actuator>
    </transmission>

    <transmission name="right_steering_trans">
        <type>transmission_interface/SimpleTransmission</type>
        <joint name="base_footprint_to_steering_link_right">
            <hardwareInterface>hardware_interface/EffortJointInterface</hardwareInterface>
        </joint>
        <actuator name="right_steer_motor">
            <hardwareInterface>hardware_interface/EffortJointInterface</hardwareInterface>
            <mechanicalReduction>1</mechanicalReduction>
        </actuator>
    </transmission>

</robot>
